# 性能测试快速演示

这是一个快速演示文档，展示如何运行性能测试并查看结果。

## 🚀 5分钟快速开始

### 步骤1: 启动WAF服务

```bash
# 如果使用Docker
cd /Users/pfinal/www/YuyuanWaf
docker-compose up -d

# 验证服务
curl http://localhost
```

### 步骤2: 运行性能测试

```bash
# 进入测试目录
cd /Users/pfinal/www/YuyuanWaf/tests/performance

# 运行完整测试(~10分钟)
bash run_all_tests.sh

# 或运行快速测试(~2分钟)
bash benchmark.sh
```

### 步骤3: 查看结果

```bash
# 查看综合报告
cat results/complete_report_*.md

# 或查看基准测试报告
cat results/benchmark_*.md
```

## 📊 测试示例输出

### 基准测试示例

```
========================================
  御渊WAF 性能基准测试
========================================

检查测试工具...
✓ Apache Bench 已安装
✓ WRK 已安装
✓ curl 已安装

=== 1. 基准测试 - 正常请求 ===

运行 AB 测试: 正常请求 (并发: 100, 请求: 10000)
  RPS: 8543.21
  平均响应时间: 11.7ms
  失败请求: 0

=== 2. 攻击检测性能测试 ===

运行 AB 测试: SQL注入检测 (并发: 100, 请求: 5000)
  RPS: 7892.34
  平均响应时间: 12.7ms
  失败请求: 5000 (全部被拦截)

========================================
  性能测试完成！
========================================

测试报告已保存到: ./results/benchmark_20251118_140000.md
```

### 性能报告示例

```markdown
# 御渊WAF 性能基准测试报告

**测试时间**: 2025-11-18 14:00:00  
**测试目标**: http://localhost

## 测试结果

### 正常请求处理能力

| 并发数 | QPS | 平均延迟 | P95延迟 | P99延迟 |
|--------|-----|----------|---------|---------|
| 1      | 1234| 0.8ms    | 1.2ms   | 1.5ms   |
| 10     | 5678| 1.8ms    | 3.2ms   | 4.5ms   |
| 50     | 7890| 6.3ms    | 12ms    | 18ms    |
| 100    | 8543| 11.7ms   | 22ms    | 35ms    |
| 200    | 8234| 24.3ms   | 48ms    | 75ms    |

### 攻击检测性能

- **SQL注入检测**: 12.7ms (增加1ms)
- **XSS检测**: 12.3ms (增加0.6ms)
- **命令注入检测**: 11.9ms (增加0.2ms)

### 结论

✅ **性能评级**: 优秀  
✅ **QPS**: 8543 (100并发)  
✅ **延迟**: P95 < 25ms  
✅ **攻击检测**: < 1ms 额外开销
```

## 🎯 性能基准对照

### 预期性能指标

| 配置 | 预期QPS | 预期延迟 |
|------|---------|----------|
| 1核2GB | 2000+ | 5-10ms |
| 2核4GB | 5000+ | 3-8ms |
| 4核8GB | 10000+ | 2-5ms |

### 实际测试结果

如果您的测试结果:
- ✅ **达到或超过预期**: 配置良好
- ⚠️  **略低于预期**: 可能需要优化
- ❌ **远低于预期**: 需要检查配置

## 📈 性能优化建议

如果性能不达预期，请尝试:

### 1. 增加Worker进程

```nginx
# nginx.conf
worker_processes auto;  # 使用所有CPU核心
```

### 2. 调整共享内存

```nginx
# waf.conf
lua_shared_dict waf_cache 200m;  # 增大缓存
```

### 3. 精简规则

```lua
-- lua/config.lua
attack_defense = {
    sql_injection = {
        check_cookie = false,  -- 关闭不必要的检查
        check_user_agent = false,
    }
}
```

### 4. 使用编译正则

```lua
-- 使用 ngx.re.compile 预编译正则表达式
local regex = require "ngx.re"
local compiled = regex.compile("pattern", "jo")
```

## 🔧 故障排查

### 问题: QPS很低

**原因可能**:
1. CPU不足
2. 内存不足
3. 规则过多/过复杂
4. 磁盘I/O慢

**解决方案**:
```bash
# 检查资源使用
top
free -h
iostat

# 查看错误日志
tail -f logs/error.log

# 优化配置(参考上述建议)
```

### 问题: 延迟很高

**原因可能**:
1. 网络延迟
2. 上游服务慢
3. 复杂规则匹配
4. 日志写入慢

**解决方案**:
```bash
# 测试网络延迟
ping localhost

# 检查上游服务
curl -w "@curl-format.txt" http://localhost/

# 优化日志
# 使用异步日志或减少日志级别
```

## 📚 更多资源

- **详细文档**: [docs/PERFORMANCE.md](../../docs/PERFORMANCE.md)
- **使用说明**: [USAGE.md](./USAGE.md)
- **测试说明**: [README.md](./README.md)

## 💡 提示

1. **首次测试**: 建议先运行单个基准测试熟悉流程
2. **生产环境**: 在低峰期进行测试
3. **对比测试**: 记录每次测试结果用于对比
4. **持续监控**: 定期运行测试跟踪性能变化

## 🎉 完成

恭喜！您已经完成了性能测试。

下一步:
- 分析测试报告
- 根据结果优化配置
- 在生产环境部署前进行压力测试
- 设置性能监控告警

如有问题，请查看详细文档或提交Issue。

