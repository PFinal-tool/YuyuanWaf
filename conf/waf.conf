# ============================================================================
# 御渊WAF - Nginx配置文件
# Version: 1.0.0
# Description: 将此配置包含到Nginx主配置中
# ============================================================================

# Lua包路径
lua_package_path "/var/www/html/YuyuanWaf/lua/?.lua;/var/www/html/YuyuanWaf/lua/lib/?.lua;/var/www/html/YuyuanWaf/lua/modules/?.lua;/var/www/html/YuyuanWaf/lua/rules/?.lua;;";

# 共享内存字典
lua_shared_dict waf_cache 100m;        # 通用缓存
lua_shared_dict waf_blacklist 50m;     # IP黑名单
lua_shared_dict waf_stats 100m;        # 统计数据
lua_shared_dict waf_rate_limit 50m;    # 频率限制

# 初始化 - 在master进程中执行
init_by_lua_block {
    -- 加载WAF核心
    waf = require "waf"
    -- 初始化WAF (设置WAF根目录)
    waf.init("/var/www/html/YuyuanWaf/")
}

# Worker进程初始化
init_worker_by_lua_block {
    local init = require "init"
    init.init_worker()
}

# 在每个server块中使用
# server {
#     listen 80;
#     server_name example.com;
#     
#     # 访问控制 - 在access阶段执行
#     access_by_lua_block {
#         waf.run()
#     }
#     
#     # 日志记录 - 在log阶段执行
#     log_by_lua_block {
#         -- 可选：记录详细日志
#     }
#     
#     location / {
#         proxy_pass http://backend;
#     }
# }
