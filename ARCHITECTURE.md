# å¾¡æ¸ŠWAF æž¶æž„è®¾è®¡æ–‡æ¡£

## ðŸ“‹ é¡¹ç›®æ¦‚è¿°

å¾¡æ¸ŠWAF æ˜¯ä¸€ä¸ªåŸºäºŽ Lua å’Œ Nginx (OpenResty) çš„å•†ä¸šåŒ– Web åº”ç”¨é˜²ç«å¢™ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š
- ðŸ›¡ï¸ é˜²çˆ¬è™«ä¿æŠ¤
- ðŸŒ IPåœ°ç†ä½ç½®è¿‡æ»¤
- ðŸ”’ å¸¸è§Webæ”»å‡»é˜²æŠ¤ (SQLæ³¨å…¥ã€XSSã€å‘½ä»¤æ³¨å…¥ç­‰)
- âš¡ CCæ”»å‡»é˜²æŠ¤
- ðŸ“Š å®žæ—¶ç›‘æŽ§å’Œç»Ÿè®¡åˆ†æž

## ðŸ—ï¸ æ•´ä½“æž¶æž„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Nginx + OpenResty                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ Inité˜¶æ®µ â”‚         â”‚ Accessé˜¶æ®µ   â”‚      â”‚ Logé˜¶æ®µ     â”‚
   â”‚åˆå§‹åŒ–é…ç½® â”‚         â”‚   è¯·æ±‚è¿‡æ»¤   â”‚      â”‚  æ—¥å¿—è®°å½•   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”             â”‚
        â”‚              â”‚  WAF Core   â”‚             â”‚
        â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
        â”‚                     â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚è§„åˆ™å¼•æ“Ž  â”‚         â”‚  IPç®¡ç†     â”‚      â”‚  ç»Ÿè®¡åˆ†æž   â”‚
   â”‚Rule     â”‚         â”‚  GeoIP      â”‚      â”‚  Dashboard  â”‚
   â”‚Engine   â”‚         â”‚  Blacklist  â”‚      â”‚  API        â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚     Redis / Shared Dict        â”‚
   â”‚   (é¢‘çŽ‡é™åˆ¶ã€é»‘åå•ç¼“å­˜)         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“ ç›®å½•ç»“æž„

```
YuyuanWaf/
â”œâ”€â”€ conf/                     # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ waf.conf             # Nginxé…ç½®ç‰‡æ®µ
â”‚   â”œâ”€â”€ config.lua           # WAFæ ¸å¿ƒé…ç½®
â”‚   â””â”€â”€ whitelist.conf       # ç™½åå•é…ç½®
â”‚
â”œâ”€â”€ lua/                      # Luaæºä»£ç 
â”‚   â”œâ”€â”€ waf.lua              # WAFæ ¸å¿ƒå…¥å£
â”‚   â”œâ”€â”€ init.lua             # åˆå§‹åŒ–æ¨¡å—
â”‚   â”œâ”€â”€ access.lua           # è¯·æ±‚è¿‡æ»¤æ¨¡å—
â”‚   â”œâ”€â”€ log.lua              # æ—¥å¿—è®°å½•æ¨¡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/             # åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ anti_crawler.lua     # é˜²çˆ¬è™«æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ip_filter.lua        # IPè¿‡æ»¤æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ geoip.lua            # åœ°ç†ä½ç½®æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ rate_limit.lua       # é¢‘çŽ‡é™åˆ¶æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ cc_defense.lua       # CCæ”»å‡»é˜²æŠ¤
â”‚   â”‚   â”œâ”€â”€ bot_detection.lua    # æœºå™¨äººæ£€æµ‹
â”‚   â”‚   â””â”€â”€ challenge.lua        # JSæŒ‘æˆ˜/éªŒè¯ç 
â”‚   â”‚
â”‚   â”œâ”€â”€ rules/               # è§„åˆ™å¼•æ“Ž
â”‚   â”‚   â”œâ”€â”€ rule_engine.lua      # è§„åˆ™å¼•æ“Žæ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ sql_injection.lua    # SQLæ³¨å…¥è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ xss.lua              # XSSæ”»å‡»è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ command_injection.lua # å‘½ä»¤æ³¨å…¥è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ file_inclusion.lua   # æ–‡ä»¶åŒ…å«è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ path_traversal.lua   # è·¯å¾„éåŽ†è§„åˆ™
â”‚   â”‚   â””â”€â”€ custom_rules.lua     # è‡ªå®šä¹‰è§„åˆ™
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                 # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ utils.lua            # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ cache.lua            # ç¼“å­˜ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ redis_client.lua     # Rediså®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ ip_utils.lua         # IPå¤„ç†å·¥å…·
â”‚   â”‚   â””â”€â”€ string_utils.lua     # å­—ç¬¦ä¸²å·¥å…·
â”‚   â”‚
â”‚   â””â”€â”€ api/                 # ç®¡ç†API
â”‚       â”œâ”€â”€ dashboard.lua        # ä»ªè¡¨ç›˜API
â”‚       â”œâ”€â”€ rules_mgmt.lua       # è§„åˆ™ç®¡ç†API
â”‚       â””â”€â”€ stats.lua            # ç»Ÿè®¡API
â”‚
â”œâ”€â”€ rules/                    # è§„åˆ™é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ sqli_patterns.json       # SQLæ³¨å…¥ç‰¹å¾åº“
â”‚   â”œâ”€â”€ xss_patterns.json        # XSSç‰¹å¾åº“
â”‚   â”œâ”€â”€ crawler_ua.json          # çˆ¬è™«UAåº“
â”‚   â”œâ”€â”€ good_bot_ua.json         # åˆæ³•çˆ¬è™«ç™½åå•
â”‚   â”œâ”€â”€ ip_blacklist.txt         # IPé»‘åå•
â”‚   â”œâ”€â”€ ip_whitelist.txt         # IPç™½åå•
â”‚   â””â”€â”€ country_blacklist.txt    # å›½å®¶é»‘åå•
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ geoip/                   # GeoIPæ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ GeoLite2-Country.mmdb
â”‚   â”‚   â””â”€â”€ GeoLite2-City.mmdb
â”‚   â””â”€â”€ fingerprint/             # æŒ‡çº¹åº“
â”‚       â””â”€â”€ device_fingerprint.db
â”‚
â”œâ”€â”€ html/                     # æ‹¦æˆªé¡µé¢
â”‚   â”œâ”€â”€ block.html               # å°ç¦é¡µé¢
â”‚   â”œâ”€â”€ captcha.html             # éªŒè¯ç é¡µé¢
â”‚   â”œâ”€â”€ 403.html                 # 403é¡µé¢
â”‚   â””â”€â”€ assets/                  # é™æ€èµ„æº
â”‚
â”œâ”€â”€ logs/                     # æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ attack.log               # æ”»å‡»æ—¥å¿—
â”‚   â”œâ”€â”€ access.log               # è®¿é—®æ—¥å¿—
â”‚   â””â”€â”€ error.log                # é”™è¯¯æ—¥å¿—
â”‚
â”œâ”€â”€ dashboard/                # Webç®¡ç†åŽå°
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ js/
â”‚   â””â”€â”€ css/
â”‚
â””â”€â”€ tests/                    # æµ‹è¯•ç›®å½•
    â”œâ”€â”€ unit/
    â””â”€â”€ integration/
```

## ðŸ”§ æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. é˜²çˆ¬è™«æ¨¡å— (anti_crawler.lua)

**å¤šç»´åº¦çˆ¬è™«æ£€æµ‹ï¼š**
- User-Agent æ£€æµ‹
- è¡Œä¸ºåˆ†æž (è¯·æ±‚é¢‘çŽ‡ã€è·¯å¾„æ¨¡å¼)
- æŒ‡çº¹è¯†åˆ« (HTTPå¤´ã€TLSæŒ‡çº¹)
- èœœç½é™·é˜±
- JSæŒ‘æˆ˜
- é€ŸçŽ‡é™åˆ¶

**é˜²çˆ¬ç­–ç•¥å±‚çº§ï¼š**
- Level 1 (è§‚å¯Ÿ): è®°å½•æ—¥å¿—ï¼Œä¸æ‹¦æˆª
- Level 2 (æŒ‘æˆ˜): JSæŒ‘æˆ˜ / éªŒè¯ç 
- Level 3 (é™é€Ÿ): é™ä½Žå“åº”é€Ÿåº¦
- Level 4 (ä¸´æ—¶å°ç¦): å°ç¦1-24å°æ—¶
- Level 5 (æ°¸ä¹…å°ç¦): åŠ å…¥é»‘åå•

### 2. IPåœ°ç†ä½ç½®è¿‡æ»¤æ¨¡å— (geoip.lua)

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- å›½å®¶çº§å’ŒåŸŽå¸‚çº§è¿‡æ»¤
- é»‘ç™½åå•æœºåˆ¶
- CIDR èŒƒå›´è¿‡æ»¤
- é«˜æ€§èƒ½ç¼“å­˜ (å‘½ä¸­çŽ‡ > 95%)
- IPv4/IPv6 æ”¯æŒ
- è‡ªåŠ¨æ›´æ–° GeoIP æ•°æ®åº“

### 3. è§„åˆ™å¼•æ“Ž (rule_engine.lua)

**è§„åˆ™ä¼˜å…ˆçº§ï¼š**
1. WHITELIST - ç™½åå•æœ€é«˜ä¼˜å…ˆçº§
2. BLACKLIST - é»‘åå•
3. GEOIP - åœ°ç†ä½ç½®è¿‡æ»¤
4. RATE_LIMIT - é¢‘çŽ‡é™åˆ¶
5. ATTACK - æ”»å‡»æ£€æµ‹
6. CRAWLER - çˆ¬è™«æ£€æµ‹

### 4. é¢‘çŽ‡é™åˆ¶æ¨¡å— (rate_limit.lua)

**ç®—æ³•æ”¯æŒï¼š**
- ä»¤ç‰Œæ¡¶ç®—æ³•
- æ»‘åŠ¨çª—å£ç®—æ³•
- æ¼æ¡¶ç®—æ³•
- å¤šç»´åº¦é™æµ (IP/URI/User)

## ðŸ›¡ï¸ WAF æ ¸å¿ƒåŠŸèƒ½æ¸…å•

### A. åŸºç¡€é˜²æŠ¤
- SQLæ³¨å…¥é˜²æŠ¤
- XSSé˜²æŠ¤
- å‘½ä»¤æ³¨å…¥é˜²æŠ¤
- æ–‡ä»¶åŒ…å«/ä¸Šä¼ é˜²æŠ¤
- OWASP Top 10 é˜²æŠ¤

### B. åçˆ¬è™«é˜²æŠ¤
- UAæ£€æµ‹
- è¡Œä¸ºåˆ†æž
- æŒ‡çº¹è¯†åˆ«
- ä¸»åŠ¨é˜²å¾¡ (JSæŒ‘æˆ˜/éªŒè¯ç )

### C. IPç®¡ç†
- åœ°ç†ä½ç½®è¿‡æ»¤
- IPä¿¡èª‰åº“
- æ™ºèƒ½å°ç¦

### D. CCæ”»å‡»é˜²æŠ¤
- æµé‡æ¸…æ´—
- æ™ºèƒ½åˆ†æž
- é˜²æŠ¤ç­–ç•¥

## ðŸ“Š å•†ä¸šåŒ–åŠŸèƒ½

### 1. Webç®¡ç†åŽå°
- å®žæ—¶ç›‘æŽ§ Dashboard
- æ”»å‡»ç»Ÿè®¡å’Œå¯è§†åŒ–
- è§„åˆ™ç®¡ç†ç•Œé¢
- IPé»‘ç™½åå•ç®¡ç†
- æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æž
- å‘Šè­¦é…ç½®
- å¤šç§Ÿæˆ·æ”¯æŒ
- æƒé™ç®¡ç† (RBAC)

### 2. APIæŽ¥å£
- RESTful APIè®¾è®¡
- è§„åˆ™ç®¡ç†
- ç»Ÿè®¡æ•°æ®
- æ—¥å¿—æŸ¥è¯¢

### 3. æ—¥å¿—å’Œå®¡è®¡
- ç»“æž„åŒ–æ—¥å¿— (JSONæ ¼å¼)
- æ—¥å¿—åˆ†çº§
- ELK/Splunk é›†æˆ
- æ”»å‡»å›žæ”¾åŠŸèƒ½

### 4. å‘Šè­¦ç³»ç»Ÿ
- é‚®ä»¶/çŸ­ä¿¡å‘Šè­¦
- Webhook (é’‰é’‰/ä¼ä¸šå¾®ä¿¡)
- å‘Šè­¦èšåˆå’ŒåŽ»é‡

## ðŸš€ æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- shared_dict ç¼“å­˜ (è¿›ç¨‹å†…)
- Redis ç¼“å­˜ (åˆ†å¸ƒå¼)
- IPæŸ¥è¯¢ç¼“å­˜ TTL: 3600s
- è§„åˆ™ç¼“å­˜ TTL: 300s

### æ€§èƒ½æŒ‡æ ‡
- å•æœº QPS: > 10ä¸‡
- å»¶è¿Ÿ: < 1ms (å‘½ä¸­ç¼“å­˜)
- CPUå ç”¨: < 10%
- å†…å­˜å ç”¨: < 200MB

## ðŸŽ¯ å®žæ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¡†æž¶ (2-3å‘¨)
- [x] WAFæ ¸å¿ƒå¼•æ“Ž
- [x] é…ç½®ç®¡ç†ç³»ç»Ÿ
- [x] IPé»‘ç™½åå•
- [x] åŸºç¡€æ—¥å¿—ç³»ç»Ÿ

### Phase 2: é˜²æŠ¤åŠŸèƒ½ (3-4å‘¨)
- [ ] SQLæ³¨å…¥é˜²æŠ¤
- [ ] XSSé˜²æŠ¤
- [ ] å‘½ä»¤æ³¨å…¥é˜²æŠ¤
- [ ] æ–‡ä»¶åŒ…å«é˜²æŠ¤
- [ ] è§„åˆ™å¼•æ“Ž

### Phase 3: åçˆ¬è™« (2-3å‘¨)
- [ ] UAæ£€æµ‹
- [ ] è¡Œä¸ºåˆ†æž
- [ ] é¢‘çŽ‡é™åˆ¶
- [ ] JSæŒ‘æˆ˜/éªŒè¯ç 
- [ ] æŒ‡çº¹è¯†åˆ«

### Phase 4: GeoIPè¿‡æ»¤ (1-2å‘¨)
- [ ] GeoIPæ•°æ®åº“é›†æˆ
- [ ] å›½å®¶é»‘ç™½åå•
- [ ] IPæ®µè¿‡æ»¤
- [ ] ç¼“å­˜ä¼˜åŒ–

### Phase 5: å•†ä¸šåŒ– (4-5å‘¨)
- [ ] Webç®¡ç†åŽå°
- [ ] APIæŽ¥å£
- [ ] ç»Ÿè®¡åˆ†æž
- [ ] å‘Šè­¦ç³»ç»Ÿ
- [ ] å¤šç§Ÿæˆ·æ”¯æŒ

### Phase 6: ä¼˜åŒ–å’Œæµ‹è¯• (2-3å‘¨)
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] åŽ‹åŠ›æµ‹è¯•
- [ ] å®‰å…¨æµ‹è¯•
- [ ] æ–‡æ¡£ç¼–å†™

## ðŸ’¡ æŠ€æœ¯æ ˆ

- **æ ¸å¿ƒ**: OpenResty (Nginx + LuaJIT)
- **GeoIP**: MaxMind GeoLite2 + lua-resty-maxminddb
- **ç¼“å­˜**: lua-resty-redis + shared_dict
- **JSON**: cjson
- **æ­£åˆ™**: ngx.re
- **åŽå°**: Vue.js + Element UI
- **æ•°æ®åº“**: Redis + MySQL
- **ç›‘æŽ§**: Prometheus + Grafana

## ðŸ“ é…ç½®ç¤ºä¾‹

å‚è€ƒ `conf/config.lua` æŸ¥çœ‹è¯¦ç»†é…ç½®é€‰é¡¹ã€‚

## ðŸ” éƒ¨ç½²æ–¹æ¡ˆ

### å•æœºéƒ¨ç½²
å‚è€ƒ `conf/waf.conf` æŸ¥çœ‹ Nginx é…ç½®ã€‚

### é›†ç¾¤éƒ¨ç½²
æ”¯æŒå¤šèŠ‚ç‚¹éƒ¨ç½²ï¼Œä½¿ç”¨ Redis ä½œä¸ºå…±äº«å­˜å‚¨ã€‚

---

**ç‰ˆæœ¬**: v1.0.0  
**æœ€åŽæ›´æ–°**: 2025-11-18

